<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background: none;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    .print-inline-btn {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      width: 100%;
      padding: 10px 0;
    }
    .print-btn {
      background: #26044e;
      color: #f79a14;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      padding: 9px 24px;
      cursor: pointer;
      font-size: 1em;
      box-shadow: 0 2px 6px #f7f8fa;
      transition: background .18s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .print-btn:hover {
     // background: #5d43a7;
      background: #fffff;
      
    }
  </style>
</head>
<body>
  <div class="print-inline-btn">
    <button class="print-btn" id="cardPrint">
      Print this card
    </button>
  </div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    console.log('print-button.html loaded');

    const t = TrelloPowerUp.iframe();

    t.render(() => {
      console.log('Trello iframe rendered');
      const btn = document.getElementById('cardPrint');

      if (!btn) {
        console.error('Print button not found in DOM');
        return;
      }

      btn.addEventListener('click', () => {
        console.log('Print button clicked');

        t.card('name', 'desc', 'cover', 'due', 'members').then(card => {
          console.log('Card data:', card);

          let coverUrl = '';
          if (card.cover?.sharedSourceUrl) {
            coverUrl = card.cover.sharedSourceUrl;
          } else if (card.cover?.url) {
            coverUrl = card.cover.url;
          }

          const due = card.due || '';
          const members = card.members?.length
            ? JSON.stringify(card.members.map(m => ({
                fullName: m.fullName,
                avatarUrl: m.avatarUrl
              })))
            : '';

          const baseUrl = 'https://cialona-erik.github.io/Cialona-Card-Printer/print.html';
          const query =
            'name=' + encodeURIComponent(card.name) +
            '&desc=' + encodeURIComponent(card.desc) +
            (coverUrl ? '&cover=' + encodeURIComponent(coverUrl) : '') +
            (due ? '&due=' + encodeURIComponent(due) : '') +
            (members ? '&members=' + encodeURIComponent(members) : '');

          const fullUrl = `${baseUrl}?${query}`;

          if (typeof t.signUrl === 'function') {
            t.signUrl(fullUrl).then(signedUrl => {
              console.log('Opening signed modal:', signedUrl);
              t.modal({
                url: signedUrl,
                title: 'Print Card - Powered by E.Zwart',
                height: 500,
                width: 880,
                fullscreen: false
              });
            }).catch(err => {
              console.error('Error signing URL:', err);
            });
          } else {
            console.log('Opening unsigned modal:', fullUrl);
            t.modal({
              url: fullUrl,
              title: 'Print Card - Powered by E.Zwart',
              height: 500,
              width: 880,
              fullscreen: false
            });
          }
        }).catch(err => {
          console.error('Error retrieving card data:', err);
        });
      });
    });
  </script>
</body>
</html>
